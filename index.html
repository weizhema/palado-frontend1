<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PALADO | æœªæ¥å±¥ç¨‹</title>
    <!-- å¼•å…¥æ¼‚äº®çš„å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Stripe å®˜æ–¹ JS åº“ -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- ==================== è¿™é‡Œæ˜¯ CSS æ ·å¼åŒºåŸŸ ==================== -->
    <style>
        /* å…¨å±€é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: #fdfbf7;
            /* æš–ç±³è‰²èƒŒæ™¯ */
            color: #1a1a1a;
        }

        /* å¯¼èˆªæ  */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 5%;
            position: fixed;
            width: 100%;
            top: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            z-index: 100;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .logo {
            font-weight: 800;
            font-size: 1.5rem;
            letter-spacing: -1px;
        }

        .nav-links {
            list-style: none;
            display: flex;
            gap: 30px;
        }


        .nav-links a {
            text-decoration: none;
            color: #666;
            font-weight: 500;
        }

        .nav-links a.active {
            color: #000;
            font-weight: 800;
        }

        .nav-right {
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* ... åŸæœ‰çš„ .nav-links ... */

        /* æ–°å¢ï¼šæœç´¢æ¡†æ ·å¼ */
        .search-box {
            display: flex;
            align-items: center;
            background: #f5f5f5;
            padding: 5px 15px;
            border-radius: 20px;
            margin-right: 20px;
        }

        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            font-size: 0.9rem;
            width: 150px;
        }

        .search-box i {
            color: #999;
        }

        /* ç»™åˆ†ç±»æŒ‰é’®åŠ ä¸ªé¼ æ ‡æ ·å¼ï¼Œè®©äººçŸ¥é“èƒ½ç‚¹ */
        .nav-links li a {
            cursor: pointer;
            transition: color 0.3s;
        }

        /* è‹±é›„åŒº */
        .hero {
            height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: linear-gradient(to bottom, #fdfbf7, #fff);
            padding-top: 60px;
        }

        .hero h1 {
            font-size: 4rem;
            line-height: 1.1;
            margin-bottom: 15px;
        }

        .hero p {
            font-size: 1.2rem;
            color: #666;
        }

        /* äº§å“åŒºåŸŸ */
        .products-section {
            padding: 50px 5%;
            min-height: 500px;
            /* ä¿è¯æ²¡æ•°æ®æ—¶ä¹Ÿæœ‰é«˜åº¦ */
        }

        .section-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .section-header h2 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* âš ï¸ å…³é”®å¸ƒå±€ï¼šç½‘æ ¼ç³»ç»Ÿ */
        .product-grid {
            display: grid;
            /* è‡ªåŠ¨é€‚åº”å±å¹•å®½åº¦ï¼Œæœ€çª„ 280px */
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 40px;
            min-height: 200px;
        }

        /* äº§å“å¡ç‰‡æ ·å¼ */
        .product-card {
            background: #fff;
            border-radius: 15px;
            padding: 15px;
            transition: transform 0.3s ease;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .product-card:hover {
            transform: translateY(-10px);
            /* æ‚¬åœä¸Šæµ® */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .product-card img {
            background-color: #f5f5f5;
            /* é˜²æ­¢å›¾ç‰‡åŠ è½½å¤±è´¥æ˜¯ä¸€ç‰‡ç™½ */
        }

        /* é¡µè„š */
        footer {
            text-align: center;
            padding: 50px;
            color: #999;
            font-size: 0.8rem;
            border-top: 1px solid #eee;
            margin-top: 50px;
        }

        /* ============ è´­ç‰©è½¦æ ·å¼ ============ */
        /* ä¾§è¾¹æ ä¸»ä½“ */
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            /* é»˜è®¤è—åœ¨å±å¹•å³è¾¹å¤–é¢ */
            width: 350px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: right 0.3s ease;
            /* é¡ºæ»‘åŠ¨ç”» */
            display: flex;
            flex-direction: column;

        }

        /* æ¿€æ´»çŠ¶æ€ï¼šæ»‘å‡ºæ¥ */
        .cart-sidebar.open {
            right: 0;
        }

        .cart-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-items {
            flex: 1;
            /* å æ®ä¸­é—´æ‰€æœ‰ç©ºé—´ */
            overflow-y: auto;
            /* å†…å®¹å¤šäº†å¯ä»¥æ»šåŠ¨ */
            padding: 20px;
        }

        /* è´­ç‰©è½¦é‡Œçš„æ¯ä¸€ä¸ªå°å•†å“ */
        .cart-item {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #f5f5f5;
            padding-bottom: 10px;
        }

        .cart-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 10px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-remove {
            color: #ff4444;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .cart-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            background: #fafafa;
        }

        .total-price {
            display: flex;
            justify-content: space-between;
            font-weight: 800;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .checkout-btn {
            width: 100%;
            padding: 15px;
            background: #000;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
        }

        /* é®ç½©å±‚ */
        .cart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            /* é»˜è®¤ä¸æ˜¾ç¤º */
        }

        .cart-overlay.open {
            display: block;
        }
    </style>
</head>
<!-- ============ âœ¨ æ–°å¢ï¼šæ™ºèƒ½å‘å¯¼å¼¹çª— (Quiz Modal) ============ -->
<style>
    /* é®ç½©å±‚ï¼šå…¨å±åŠé€æ˜ */
    .quiz-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.98);
        /* çº¯ç™½èƒŒæ™¯ï¼Œæ›´æœ‰é«˜çº§æ„Ÿ */
        z-index: 2000;
        display: none;
        /* é»˜è®¤éšè— */
        justify-content: center;
        align-items: center;
    }

    /* é—®å·ç›’å­ */
    .quiz-box {
        text-align: center;
        max-width: 500px;
        width: 90%;
        animation: slideUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        /* å¼¹æ€§åŠ¨ç”» */
    }

    @keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* æ­¥éª¤æ§åˆ¶ */
    .quiz-step {
        display: none;
    }

    .quiz-step.active {
        display: block;
    }

    /* é€‰é¡¹æŒ‰é’® */
    .quiz-option {
        display: block;
        width: 100%;
        padding: 20px;
        margin: 15px 0;
        border: 2px solid #eee;
        border-radius: 15px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: 0.3s;
        background: white;
        font-weight: 600;
        color: #333;
    }

    .quiz-option:hover {
        border-color: #000;
        background: #000;
        color: #fff;
        transform: translateY(-3px);
    }

    /* è¾“å…¥æ¡†ç¾åŒ– */
    .quiz-input {
        width: 100%;
        padding: 15px;
        font-size: 1.5rem;
        border: none;
        border-bottom: 2px solid #ddd;
        outline: none;
        text-align: center;
        background: transparent;
        margin-bottom: 30px;
        font-weight: bold;
    }

    .quiz-input:focus {
        border-bottom-color: #000;
    }
</style>

<div id="quiz-overlay" class="quiz-overlay">
    <div class="quiz-box">
        <!-- å…³é—­æŒ‰é’® -->
        <button onclick="closeQuiz()"
            style="position:absolute; top:30px; right:30px; border:none; background:none; font-size:2rem; cursor:pointer; color:#999;">&times;</button>

        <!-- ğŸŸ¢ æ­¥éª¤ 1: è¯¢é—®åå­— (å»ºç«‹æƒ…æ„Ÿè¿æ¥) -->
        <div id="step-1" class="quiz-step active">
            <h2 style="font-size:2rem; margin-bottom:10px;">ğŸ‘‹ Hi!</h2>
            <p style="color:#666; margin-bottom:30px;">é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ€ä¹ˆç§°å‘¼ä½ ï¼Ÿ</p>
            <input type="text" id="quiz-name" class="quiz-input" placeholder="è¾“å…¥ä½ çš„åå­—..." autocomplete="off">
            <button onclick="nextToStep2()" class="checkout-btn"
                style="width: auto; padding: 12px 50px; border-radius:30px;">ä¸‹ä¸€æ­¥ â</button>
        </div>

        <!-- ğŸŸ¢ æ­¥éª¤ 2: è¯¢é—®ç”¨é€” (ç­›é€‰é€»è¾‘) -->
        <div id="step-2" class="quiz-step">
            <h2 style="font-size:2rem; margin-bottom:30px;">å¾ˆé«˜å…´è®¤è¯†ä½ ï¼Œ<span id="display-name"
                    style="color:#7380ec;"></span>!</h2>
            <p style="color:#666; margin-bottom:20px;">ä½ ä¹°é‹çš„ä¸»è¦åœºæ™¯æ˜¯ï¼Ÿ</p>
            <button class="quiz-option" onclick="finishQuiz('running')">ğŸƒâ€â™‚ï¸ ä¸“ä¸šè·‘æ­¥ / å¥èº«è®­ç»ƒ</button>
            <button class="quiz-option" onclick="finishQuiz('casual')">â˜• æ—¥å¸¸é€šå‹¤ / åŸå¸‚æ¼«æ­¥</button>
        </div>

        <!-- ğŸŸ¢ æ­¥éª¤ 3: æ¨èç»“æœ (è½¬åŒ–æˆäº¤) -->
        <div id="step-3" class="quiz-step">
            <h2 style="margin-bottom:10px;">ğŸ‰ æ‰¾åˆ°äº†ï¼</h2>
            <p style="color:#666;">æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œè¿™åŒé‹å†™ç€ä½ çš„åå­—ï¼š</p>

            <!-- æ¨èç»“æœå¡ç‰‡å®¹å™¨ -->
            <div id="recommendation-result" style="margin: 30px 0;">
                <!-- JS ä¼šæŠŠé‹å­å¡åˆ°è¿™é‡Œ -->
            </div>

            <button onclick="closeQuiz()"
                style="color:#999; background:none; border:none; cursor:pointer; text-decoration:underline; font-size:0.9rem;">æŸ¥çœ‹æ‰€æœ‰é‹æ¬¾</button>
        </div>
    </div>
</div>

<body>
    <!-- 1. é¡¶éƒ¨é€šçŸ¥æ  -->
    <div class="announcement-bar">
        <p>ğŸ‰ æ–°äººé¦–å•ç«‹å‡ $20 | å…¨åœºæ»¡ $150 å…è¿è´¹ ğŸšš</p>
    </div>
    <!-- 1. å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="logo">PALADO.</div>

        <!-- æœç´¢æ¡† -->
        <div class="search-box">
            <span style="margin-right:5px">ğŸ”</span>
            <input type="text" id="search-input" placeholder="æœç´¢é‹æ¬¾..." oninput="handleSearch()">
        </div>

        <ul class="nav-links">
            <!-- æ³¨æ„ï¼šonclick é‡Œé¢è°ƒç”¨äº† filterProducts å‡½æ•° -->
            <li><a onclick="filterProducts('all')" class="active" id="btn-all">å…¨éƒ¨</a></li>
            <li><a onclick="filterProducts('running')" id="btn-running">è·‘æ­¥</a></li>
            <li><a onclick="filterProducts('casual')" id="btn-casual">ä¼‘é—²</a></li>
        </ul>

        <div class="nav-right">
            <span>CART (0)</span>
        </div>
    </nav>

    <!-- 2. è‹±é›„æµ·æŠ¥åŒº (å·²å‡çº§ï¼šBarkBox é£æ ¼å…¥å£) -->
    <header class="hero">
        <div class="hero-content">
            <h1 style="margin-bottom: 20px;">ä¸ä»…ä»…æ˜¯é‹å­<br>æ˜¯ä½ çš„<span style="color:#7380ec;">ä¸“å±å±¥ç¨‹</span></h1>
            <p style="margin-bottom: 30px; color: #555;">å›ç­” 2 ä¸ªç®€å•é—®é¢˜ï¼Œä¸ºä½ åŒ¹é…å®Œç¾é‹æ¬¾ã€‚</p>

            <!-- âœ¨ æ ¸å¿ƒæŒ‰é’®ï¼šç‚¹å‡»è§¦å‘é—®å· -->
            <button onclick="startQuiz()" style="
                padding: 15px 40px;
                background: #000;
                color: #fff;
                border: none;
                border-radius: 50px;
                font-size: 1.1rem;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 10px 20px rgba(0,0,0,0.2);
                transition: transform 0.2s;
            " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                ğŸš€ å¼€å§‹æˆ‘çš„å®šåˆ¶æµ‹è¯•
            </button>
        </div>
    </header>

    <!-- 3. äº§å“å±•ç¤ºåŒº (å…³é”®åŒºåŸŸ) -->
    <section class="products-section">
        <div class="section-header">
            <h2>ç²¾é€‰ç³»åˆ—</h2>
            <p>2025 æ˜¥å­£æ–°æ¬¾</p>
        </div>

        <!-- âš ï¸ å…³é”®ç‚¹ï¼šè¿™ä¸ª ID å¿…é¡»å« product-gridï¼ŒJS æ‰èƒ½æ‰¾åˆ°å®ƒ -->
        <div id="product-grid" class="product-grid">
            <!-- æ­£åœ¨åŠ è½½æ—¶çš„å ä½ç¬¦ -->
            <div style="grid-column: 1/-1; text-align: center; padding: 50px; color: #999;">
                <p>â³ æ­£åœ¨å‘¼å«åç«¯ä»“åº“...</p>
            </div>
        </div>
    </section>

    <!-- 4. é¡µè„š -->
    <footer>
        <p>Â© 2025 PALADO SHOES.</p>
    </footer>

    <!-- ğŸ›’ è´­ç‰©è½¦ä¾§è¾¹æ  (é»˜è®¤éšè—) -->
    <div id="cart-sidebar" class="cart-sidebar">
        <div class="cart-header">
            <h2>ä½ çš„è´­ç‰©è½¦</h2>
            <button onclick="toggleCart()" class="close-btn">&times;</button>
        </div>

        <!-- è´­ç‰©è½¦é‡Œçš„åˆ—è¡¨ -->
        <div id="cart-items" class="cart-items">
            <!-- JS ä¼šæŠŠå•†å“å¡åˆ°è¿™é‡Œ -->
            <p style="text-align:center; color:#999; margin-top:50px;">è´­ç‰©è½¦æ˜¯ç©ºçš„</p>
        </div>

        <div class="cart-footer">
            <!-- 1. æ€»ä»·æ˜¾ç¤º -->
            <div class="total-price">
                <span>æ€»è®¡:</span>
                <span id="cart-total">$0</span>
            </div>

            <!-- 2. ğŸ‘‡ è¿™é‡Œå°±æ˜¯ä½ è¦è¡¥åŠ çš„è¾“å…¥æ¡† ğŸ‘‡ -->
            <!-- 2. è¾“å…¥æ¡†åŒºåŸŸ (å·²å‡çº§) -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="cust-name" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å"
                    style="width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; outline: none;">

                <!-- âœ¨ æ–°å¢ï¼šé‚®ç®±è¾“å…¥æ¡† -->
                <input type="email" id="cust-email" placeholder="æ‚¨çš„ç”µå­é‚®ç®± (æ¥æ”¶è®¢å•é€šçŸ¥)"
                    style="width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; outline: none;">

                <input type="text" id="cust-addr" placeholder="è¯·è¾“å…¥æ”¶è´§åœ°å€"
                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; outline: none;">
            </div>

            <!-- 3. æ”¯ä»˜æŒ‰é’® -->
            <button class="checkout-btn" onclick="submitOrder()">ğŸ’³ ç«‹å³æ”¯ä»˜</button>
        </div>
    </div>
    <!-- é®ç½©å±‚ (ç‚¹èƒŒæ™¯å…³é—­è´­ç‰©è½¦) -->
    <div id="cart-overlay" class="cart-overlay" onclick="toggleCart()"></div>
    <!-- ==================== è¿™é‡Œæ˜¯ JS é€»è¾‘åŒºåŸŸ ==================== -->
    <script>
        // =================é…ç½®åŒºåŸŸ=================
        // åœ¨ script é¡¶éƒ¨å®šä¹‰
        const BASE_URL = 'http://localhost:5000'; // æœ¬åœ°å¼€å‘ç”¨è¿™ä¸ª
        // const BASE_URL = 'https://palado-backend1.onrender.com'; // ä¸Šçº¿ç”¨è¿™ä¸ª

        const API_URL = `${BASE_URL}/api/products`;
        const ORDER_URL = `${BASE_URL}/api/orders`;

        const productGrid = document.getElementById('product-grid');
        let cart = JSON.parse(localStorage.getItem('myCart')) || [];

        // ğŸŒŸ æ–°å¢ï¼šå…¨å±€å˜é‡ï¼Œç”¨æ¥å­˜â€œæ‰€æœ‰é‹å­â€çš„åŸå§‹æ•°æ®
        let allProductsData = [];

        // ================= 1. å¯åŠ¨é€»è¾‘ =================
        document.addEventListener('DOMContentLoaded', () => {

            fetchProducts();
            checkPaymentStatus();
            updateCartUI();
        });

        // æ–°å¢å‡½æ•°ï¼šæ£€æŸ¥ URL å‚æ•°
        // æ£€æŸ¥ URL å‚æ•° (å¤„ç†æ”¯ä»˜å›è°ƒ)
        async function checkPaymentStatus() {
            const urlParams = new URLSearchParams(window.location.search);
            // console.log... (ä¹‹å‰çš„çªƒå¬å™¨ä»£ç å¯ä»¥ç•™ç€)

            if (urlParams.get('status') === 'success') {

                // 1. å–å‡ºæ•°æ®
                const tempCustomer = JSON.parse(localStorage.getItem('tempCustomer')) || {};

                // 2. å‡†å¤‡å‘ç»™åç«¯çš„æ•°æ®
                const total = cart.reduce((sum, item) => sum + item.price, 0);
                const orderData = {
                    customerName: tempCustomer.name || "åŒ¿åé¡¾å®¢",
                    address: tempCustomer.address || "é»˜è®¤åœ°å€",
                    email: tempCustomer.email, // ğŸ‘ˆ âœ¨ æ ¸å¿ƒï¼šæŠŠå–å‡ºæ¥çš„é‚®ç®±å‘ç»™åç«¯ï¼
                    items: cart,
                    totalPrice: total
                };

                try {
                    // 3. å­˜å…¥åç«¯
                    await fetch(`${BASE_URL}/api/orders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderData)
                    });

                    alert(`ğŸ‰ æ”¯ä»˜æˆåŠŸï¼è°¢è°¢ä½ ï¼Œ${tempCustomer.name}ï¼è®¢å•å·²ç”Ÿæˆã€‚`);

                } catch (err) {
                    console.error("è®¢å•ä¿å­˜å¤±è´¥:", err);
                }

                // 4. æ¸…ç†å·¥ä½œ
                cart = [];
                localStorage.removeItem('myCart');
                localStorage.removeItem('tempCustomer'); // ç”¨å®Œå°±æŠŠåå­—æ‰”æ‰
                updateCartUI();
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        // ================= ğŸ§  æ™ºèƒ½é—®å·é€»è¾‘ (BarkBox æ ¸å¿ƒ) =================

        let userPreferences = {
            name: '',
            category: ''
        };

        // 1. æ‰“å¼€é—®å·
        function startQuiz() {
            document.getElementById('quiz-overlay').style.display = 'flex';
            // é‡ç½®åˆ°ç¬¬ä¸€æ­¥
            showStep(1);
        }

        // 2. å…³é—­é—®å·
        function closeQuiz() {
            document.getElementById('quiz-overlay').style.display = 'none';
        }

        // 3. è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºç¬¬å‡ æ­¥
        function showStep(stepNumber) {
            // å…ˆéšè—æ‰€æœ‰æ­¥éª¤
            document.querySelectorAll('.quiz-step').forEach(el => el.classList.remove('active'));
            // æ˜¾ç¤ºæŒ‡å®šæ­¥éª¤
            document.getElementById(`step-${stepNumber}`).classList.add('active');
        }

        // 4. ä»ç¬¬ä¸€æ­¥å»ç¬¬äºŒæ­¥
        function nextToStep2() {
            const nameInput = document.getElementById('quiz-name');
            const name = nameInput.value.trim();

            if (!name) return alert("è¯·å‘Šè¯‰æˆ‘ä»¬è¦æ€ä¹ˆç§°å‘¼ä½ å‘€ ğŸ˜Š");

            userPreferences.name = name;
            // æŠŠåå­—å¡«åˆ°ç¬¬äºŒæ­¥çš„æ ‡é¢˜é‡Œï¼Œå¢åŠ äº²åˆ‡æ„Ÿ
            document.getElementById('display-name').innerText = name;

            // é¡ºä¾¿æŠŠåå­—å­˜åˆ° localStorageï¼Œæ”¯ä»˜çš„æ—¶å€™è‡ªåŠ¨å¡«å…¥
            // è¿™æ ·ç”¨æˆ·ä½“éªŒæä½³ï¼šä¸ç”¨å¡«ä¸¤éåå­—ï¼
            localStorage.setItem('tempCustomer', JSON.stringify({ name: name, address: '' }));

            // ä¹Ÿå¯ä»¥é¢„å¡«å……è´­ç‰©è½¦åº•éƒ¨çš„åå­—æ¡†ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const cartNameInput = document.getElementById('cust-name');
            if (cartNameInput) cartNameInput.value = name;

            showStep(2);
        }

        // 5. å®Œæˆé—®å·ï¼Œç”Ÿæˆæ¨è
        function finishQuiz(category) {
            userPreferences.category = category;

            // ğŸ¤– æ ¸å¿ƒç®—æ³•ï¼šåœ¨ allProductsData é‡Œæ‰¾åŒ¹é…çš„
            // æ¯”å¦‚ï¼šä½ é€‰äº† 'running'ï¼Œå°±åœ¨ allProductsData é‡Œæ‰¾ category === 'running' çš„é‹
            const matches = allProductsData.filter(item => item.category === category);

            // ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œæˆ‘ä»¬å–ç¬¬ä¸€ä¸ªåŒ¹é…çš„ï¼Œæˆ–è€…éšæœºå–ä¸€ä¸ª
            // å¦‚æœæ²¡åº“å­˜äº†ï¼Œå°±é»˜è®¤æ¨èç¬¬ä¸€åŒï¼Œé˜²æ­¢æŠ¥é”™
            const recommendProduct = matches.length > 0 ? matches[0] : allProductsData[0];

            if (!recommendProduct) {
                alert("æ•°æ®è¿˜æ²¡åŠ è½½å®Œï¼Œè¯·ç¨åå†è¯•ï¼");
                return;
            }

            // æ¸²æŸ“æ¨èå¡ç‰‡
            const resultContainer = document.getElementById('recommendation-result');
            resultContainer.innerHTML = `
                <div style="
                    background: #fff; 
                    border-radius: 20px; 
                    padding: 20px; 
                    box-shadow: 0 15px 40px rgba(115, 128, 236, 0.15);
                    transform: scale(1.05);
                    border: 2px solid #7380ec;
                ">
                    <div style="position:relative;">
                        <img src="${recommendProduct.img}" style="width:100%; height:200px; object-fit:cover; border-radius:10px; margin-bottom:15px;">
                        <span style="position:absolute; top:10px; left:10px; background:#000; color:#fff; padding:5px 10px; font-size:0.8rem; border-radius:20px;">
                            ${userPreferences.name} çš„ä¸“å±æ¨è
                        </span>
                    </div>
                    
                    <h3 style="margin-bottom:5px; font-size:1.4rem;">${recommendProduct.name}</h3>
                    <p style="color:#666; font-size:0.9rem; margin-bottom:15px;">
                        ${category === 'running' ? 'ğŸš€ ä¸“ä¸ºé€Ÿåº¦ä¸è€åŠ›è®¾è®¡' : 'ğŸƒ ä¸“ä¸ºèˆ’é€‚ä¸é£æ ¼è®¾è®¡'}
                    </p>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                        <div style="font-size:1.5rem; font-weight:800;">$${recommendProduct.price}</div>
                        <button onclick="addToCart('${recommendProduct._id}'); closeQuiz(); toggleCart();" 
                            class="checkout-btn" style="width:auto; padding:10px 20px;">
                            ğŸ æ”¾å…¥è´­ç‰©è½¦
                        </button>
                    </div>
                </div>
            `;

            showStep(3);
        }
        // ================= 2. è·å–æ•°æ® (ç¨å¾®æ”¹ä¸€ç‚¹ç‚¹) =================
        async function fetchProducts() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("è¿æ¥åç«¯å¤±è´¥");

                // æ‹¿åˆ°æ•°æ®
                const products = await response.json();

                // ğŸŒŸ å…³é”®åŠ¨ä½œï¼šæŠŠæ•°æ®å­˜è¿›â€œæ€»è´¦æœ¬â€
                allProductsData = products;

                // ä¸€å¼€å§‹æ˜¾ç¤ºæ‰€æœ‰äº§å“
                renderProducts(products);

            } catch (error) {
                console.error(error);
                productGrid.innerHTML = `<p style="text-align:center;">âš ï¸ æ•°æ®åŠ è½½å¤±è´¥</p>`;
            }
        }

        // ================= ğŸŒŸ æ–°å¢ï¼šç­›é€‰ä¸æœç´¢åŠŸèƒ½ =================

        // A. æŒ‰åˆ†ç±»ç­›é€‰ (ç‚¹å¯¼èˆªæ æŒ‰é’®æ—¶è§¦å‘)
        function filterProducts(category) {
            // 1. åˆ‡æ¢æŒ‰é’®çš„â€œåŠ ç²—â€çŠ¶æ€ (è§†è§‰æ•ˆæœ)
            document.querySelectorAll('.nav-links a').forEach(el => el.classList.remove('active'));
            document.getElementById(`btn-${category}`).classList.add('active');

            // 2. ç­›é€‰æ•°æ®
            if (category === 'all') {
                // å¦‚æœé€‰å…¨éƒ¨ï¼Œå°±ç»™æ‰€æœ‰æ•°æ®
                renderProducts(allProductsData);
            } else {
                // å¦åˆ™ï¼Œåªç•™ä¸‹ category ç­‰äº ç›®æ ‡åˆ†ç±» çš„é‹å­
                const filtered = allProductsData.filter(item => item.category === category);
                renderProducts(filtered);
            }
        }

        // B. æœç´¢åŠŸèƒ½ (è¾“å…¥æ–‡å­—æ—¶è§¦å‘)
        function handleSearch() {
            const keyword = document.getElementById('search-input').value.toLowerCase(); // è½¬å°å†™ï¼Œä¸åŒºåˆ†å¤§å°å†™

            // åœ¨åå­—é‡Œæ‰¾å…³é”®è¯
            const searched = allProductsData.filter(item =>
                item.name.toLowerCase().includes(keyword)
            );

            renderProducts(searched);
        }

        // ================= 3. æ¸²æŸ“å•†å“ =================
        function renderProducts(products) {
            productGrid.innerHTML = '';
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                // æ³¨æ„ï¼šä¸‹é¢çš„ button onclick äº‹ä»¶å˜äº†
                // æˆ‘ä»¬æŠŠæ•´ä¸ª product å¯¹è±¡å˜æˆäº†å­—ç¬¦ä¸²ä¼ è¿›å»ï¼Œæ–¹ä¾¿è¯»å–
                const productStr = JSON.stringify(product).replace(/"/g, '&quot;');

                card.innerHTML = `
                    <div style="background:#eee; border-radius:10px; overflow:hidden; height:250px;">
                        <img src="${product.img}" alt="${product.name}" style="width:100%; height:100%; object-fit:cover;">
                    </div>
                    <div style="padding:15px 0; display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="font-size:1.1rem; margin:0; font-weight:700;">${product.name}</h3>
                        <span style="color:#3b5bdb; font-weight:bold; font-size:1.2rem;">$${product.price}</span>
                    </div>
                    <button onclick="addToCart('${product._id}')">åŠ å…¥è´­ç‰©è½¦</button>
                    
                    åŠ å…¥è´­ç‰©è½¦
                    </button>
                `;
                productGrid.appendChild(card);
            });
        }

        // ================= 4. ğŸ›’ è´­ç‰©è½¦æ ¸å¿ƒé€»è¾‘ (é‡ç‚¹ï¼) =================

        // A. æ·»åŠ åˆ°è´­ç‰©è½¦
        function addToCart(id) {
            // åœ¨æ€»æ•°æ®é‡Œæ‰¾åˆ°è¿™ä¸ªå•†å“
            const targetProduct = allProductsData.find(item => item._id === id);
            if (targetProduct) {
                cart.push(targetProduct);
                saveCart();
                updateCartUI();
                toggleCart();
            }
        }

        // B. ä»è´­ç‰©è½¦ç§»é™¤ (æ ¹æ®ç´¢å¼• index)
        function removeFromCart(index) {
            cart.splice(index, 1); // åˆ æ‰ç¬¬å‡ ä¸ª
            saveCart();
            updateCartUI();
        }

        // C. ä¿å­˜æ•°æ® (æŒä¹…åŒ–)
        function saveCart() {
            // localStorage åªèƒ½å­˜å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥è¦ JSON.stringify
            localStorage.setItem('myCart', JSON.stringify(cart));
        }

        // D. æ›´æ–°ç•Œé¢ (ç”»å‡ºä¾§è¾¹æ çš„å†…å®¹)
        function updateCartUI() {
            // 1. æ›´æ–°å³ä¸Šè§’çš„æ•°å­—
            const navRight = document.querySelector('.nav-right span');
            navRight.innerText = `CART (${cart.length})`;
            // ç»™æ–‡å­—åŠ ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å®ƒä¹Ÿèƒ½æ‰“å¼€è´­ç‰©è½¦
            navRight.style.cursor = 'pointer';
            navRight.onclick = toggleCart;

            // 2. æ›´æ–°ä¾§è¾¹æ é‡Œçš„åˆ—è¡¨
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalElement = document.getElementById('cart-total');

            cartItemsContainer.innerHTML = ''; // å…ˆæ¸…ç©º
            let totalPrice = 0;

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">ç©ºç©ºå¦‚ä¹Ÿ...</p>';
            } else {
                cart.forEach((item, index) => {
                    totalPrice += item.price; // ç´¯åŠ ä»·æ ¼
                    cartItemsContainer.innerHTML += `
                        <div class="cart-item">
                            <img src="${item.img}">
                            <div class="cart-item-info">
                                <h4>${item.name}</h4>
                                <div>$${item.price}</div>
                            </div>
                            <div class="cart-remove" onclick="removeFromCart(${index})">åˆ é™¤</div>
                        </div>
                    `;
                });
            }

            // 3. æ›´æ–°æ€»ä»·
            cartTotalElement.innerText = '$' + totalPrice;
        }

        // E. å¼€å…³ä¾§è¾¹æ åŠ¨ç”»
        function toggleCart() {
            const sidebar = document.getElementById('cart-sidebar');
            const overlay = document.getElementById('cart-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }
        // ================= 5. ğŸ’³ Stripe æ”¯ä»˜åŠŸèƒ½ (æ–°ç‰ˆ) =================

        // 1. åˆå§‹åŒ– Stripe (ä½¿ç”¨åˆšæ‰ä½ å‘çš„å…¬é’¥)
        const stripe = Stripe('pk_test_51SYdsIQr6341tjDEOCmUjmguA4yTzcOIfcaR0x7Ohya7HFRjV0lsuLHJJeOVUV6pMpdnMo5tTNR0ACUAvi75LqUN009LfHTz2w');

        async function submitOrder() {
            if (cart.length === 0) return alert("è´­ç‰©è½¦ä¸ºç©º");

            // è·å–è¾“å…¥æ¡†çš„å€¼
            const nameInput = document.getElementById('cust-name');
            const addrInput = document.getElementById('cust-addr');
            const emailInput = document.getElementById('cust-email'); // ğŸ‘ˆ è·å–é‚®ç®±æ¡†

            const name = nameInput ? nameInput.value : "é¡¾å®¢";
            const addr = addrInput ? addrInput.value : "çº¿ä¸Šåœ°å€";
            const email = emailInput ? emailInput.value : ""; // ğŸ‘ˆ è·å–å€¼

            // ğŸ›¡ï¸ ç®€å•éªŒè¯ï¼šæ²¡å¡«é‚®ç®±ä¸è®©ä¹°
            if (!email || !email.includes('@')) {
                return alert("ä¸ºäº†æ¥æ”¶è®¢å•é€šçŸ¥ï¼Œè¯·å¡«å†™æ­£ç¡®çš„é‚®ç®±åœ°å€ï¼ğŸ“§");
            }

            // 2. å­˜è¿›â€œä¸´æ—¶å°èƒŒåŒ…â€ (å…³é”®ï¼æŠŠ email å­˜è¿›å»)
            localStorage.setItem('tempCustomer', JSON.stringify({
                name: name,
                address: addr,
                email: email // ğŸ‘ˆ å­˜è¿›å»ï¼
            }));

            const btn = document.querySelector('.checkout-btn');
            btn.innerText = "â³ æ­£åœ¨è·³è½¬...";
            btn.disabled = true;

            try {
                // 3. å»åç«¯åˆ›å»ºæ”¯ä»˜ä¼šè¯
                const res = await fetch(`${BASE_URL}/api/create-checkout-session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: cart })
                });
                const session = await res.json();
                if (session.error) { alert(session.error); btn.disabled = false; return; }

                await stripe.redirectToCheckout({ sessionId: session.id });
            } catch (err) {
                alert("æ”¯ä»˜è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯");
                btn.disabled = false;
                btn.innerText = "ğŸ’³ ç«‹å³æ”¯ä»˜";
            }
        }

    </script>

</body>

</html>